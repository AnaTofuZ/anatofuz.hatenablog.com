---
Title: Perl6ã¨å¤šè¨€èªã®èµ·å‹•æ™‚é–“ã®æ¯”è¼ƒ(Perl5,Ruby,Python,Java,Perl6 on MoarVM,Perl6 on JVM)
Category:
- Ruby
- Python
- Perl6
- Perl
- Java
Date: 2018-07-18T18:21:24+09:00
URL: https://anatofuz.hatenablog.com/entry/2018/07/18/182124
EditURL: https://blog.hatena.ne.jp/anatofuz/anatofuz.hatenablog.com/atom/entry/10257846132602354426
---

## è¿½è¨˜(2018/07/19)

å‡¦ç†é€Ÿåº¦ã§ã¯ãªãã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èµ·å‹•æ™‚é–“ã¨ã„ã†ã”æŒ‡æ‘˜ã‚’å—ã‘ãŸã®ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¿®æ­£ã—ã¾ã—ãŸğŸ™ğŸ™
ç´”ç²‹ãªå‡¦ç†æ™‚é–“ã®æ¸¬å®šã¯åˆ¥é€”è¡ŒãŠã†ã¨æ€ã„ã¾ã™ï¼å¾ŒåŠã®æ„Ÿæƒ³ã®éƒ¨åˆ†ã¯èª­ã¿æµã—ã¦é ‚ã‘ã‚‹ã¨ ğŸ™‡ ğŸ™‡ 


## ç›®çš„

ä»Šå›ã¯[ä»¥å‰ã®ã‚¨ãƒ³ãƒˆãƒª](https://anatofuz.hatenablog.com/entry/2018/07/06/225127)ã§æ›¸ã„ãŸã‚ˆã†ãªPerl6ã®æ­£è¦è¡¨ç¾ãªã©ã‚’ä½¿ã„åŒã˜å‡¦ç†ã‚’ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒï¼Œå„è¨€èªã§ã©ã†ã„ã£ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å·®ãŒå‡ºã‚‹ã‹ã®æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ï¼

## é¡Œæ

é¡Œæã¨ã—ã¦ã¯mac os Xã® `/var/log/system.log`ã®ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®å›æ•°ã‚’æ•°ãˆä¸Šã’ã‚‹ã¨ã„ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ï¼
å‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ã¾ãšã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ç¢ºèªã—ï¼Œãã‚Œã«å¿œã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ï¼
é–‹ãã“ã¨ãŒæƒ³å®šã•ã‚Œã¦ã„ã‚‹`/var/log/system.log`ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®ã‚ˆã†ãªå½¢å¼ã«ãªã£ã¦ã„ã¾ã™ï¼

```txt
Jul 18 01:31:55 anatofuzMBP Dropbox[96084]: [0718/013155:WARNING:dns_config_service_posix.cc(306)] Failed to read DnsCo>
Jul 18 16:57:52 anatofuz-15 idea[66753]: BUG in libdispatch client: kevent[mach_recv] monitored resource vanished befor>
```

ã“ã“ã‹ã‚‰æ­£è¦è¡¨ç¾ã§ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®åå‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ï¼Œä¸€åº¦é€£æƒ³é…åˆ—ã‚’åˆ©ç”¨ã—ã¦ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®å‡ºç¾å›æ•°ã‚’æ•°ãˆä¸Šã’ã¾ã™ï¼
æœ€çµ‚çš„ã«é€£æƒ³é…åˆ—ã®keyã‚’foræ–‡ã§ãƒ«ãƒ¼ãƒ—ã•ã›ãªãŒã‚‰ï¼Œãã‚Œãã‚Œã®åˆè¨ˆã‚’è¨ˆç®—ã™ã‚‹ã¨ã„ã†æµã‚Œã§ã™ï¼


## å®Ÿé¨“

 ä»Šå›ã¯Perl6(MoarVM)ã¨Perl6(JVM)ã®é€Ÿåº¦æ¯”è¼ƒã‚’ä¸­å¿ƒã«è¡Œã„ã¾ã—ãŸï¼
è§£èª¬ã™ã‚‹ã¨Perl6ã¯ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹VMãŒç¾åœ¨MoarVMã‹JVMã‹é¸æŠå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ç‚ºï¼Œã“ã®ï¼’ã¤ã®é€Ÿåº¦å·®ã‚’å›³ã‚Šã¾ã™ï¼
ã¾ãŸãƒ©ã‚¤ãƒãƒ«ã¨ãªã‚‹Ruby,Python,Perl5ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã‚„ï¼ŒJVMè‡ªä½“ã®é€Ÿåº¦ã®æ¸¬å®šã®ãŸã‚ã«javaã§ã‚‚å®Ÿé¨“ã—ã¾ã—ãŸï¼

- perl v5.26.2
- ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-darwin17]
- Python 3.7.0
- java 10.0.1 2018-04-17
- Rakudo version 2018.04.1 built on MoarVM version 2018.04.1 (debugã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ã)
- Rakudo Star version 2018.04.1 built on MoarVM version 2018.04.1
- Rakudo version 2018.06-163-g612d071b8 built on JVM

###  å®Ÿé¨“ã‚³ãƒ¼ãƒ‰

ä»Šå›ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ãƒªãƒã‚¸ãƒˆãƒªã®pushã—ã¦ã„ã¾ã™ï¼


[https://github.com/AnaTofuZ/log-analyze-example:embed:cite]


[http://www.cr.ie.u-ryukyu.ac.jp/hg/Members/anatofuz/Perl6_log_analyze_example/file/tip:title]

æ›¸ãæ–¹ã‚’ã‚ã‚‹ç¨‹åº¦çµ±ä¸€ã—ï¼Œç´”ç²‹ãªè¨€èªæ©Ÿèƒ½ã®æ¸¬å®šã‚’è¡Œã„ã¾ã™ï¼

### Perl5

```perl
#!/usr/bin/env perl
use strict;
use warnings;

my $file = "/var/log/system.log";

if(@ARGV == 2){
    if ( $ARGV[0] eq "-f"){
        $file = $ARGV[1];
    }
}

my $user_name = qr/anatofuzMBP|anatofuz-15/;
open my $fh, "<",$file;
my $count = {};

while (my $line = <$fh>) {
    if ( $line =~ /\w \d{0,2} (?:\d{2}:?){3} $user_name ([\w.]+)\[\d+\]/){
        $count->{$1}++;
    }
}

my $sum = 0;

for my $key (keys %$count){
    $sum += $count->{$key};
}

print "$sum\n";

```

ç´ æœ´ã«ãƒãƒƒã‚·ãƒ¥ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«åŠ ç®—ã—ã¦ã„ã¾ã™

### Ruby

```ruby
#!/usr/bin/env ruby

file = "/var/log/system.log"

user_name = Regexp.new("anatofuzMBP|anatofuz-15")
count = Hash.new(0)

File.open(file,'r') do |f|
    f.each_line do |line|
        if line =~ /\w+ \d{0,2} (?:\d{2}:?){3} #{user_name} ([\w.]+)\[\d+\]/
            count[$1] += 1
        end
    end
end


sum = 0

for key in count.keys
    sum += count[key]
end

p sum

```

æ›¸ãæ–¹ã‚’çµ±ä¸€ã™ã‚‹ãŸã‚ã«ã‚ãˆã¦æœ€å¾Œã¯foræ–‡ã§Loopã‚’ã•ã›ã¦ã„ã¾ã™ï¼
Rubyã§forã¨ã‹æ•°ç™¾å¹´ã¶ã‚Šã«æ›¸ã„ãŸã‹ã‚‚çŸ¥ã‚Œãªã„

### Python

```python
#!/usr/bin/env python
import re
import sys
from collections import defaultdict

file_path = "/var/log/system.log"
args = sys.argv

if args == 3:
    if args[1] == "-f":
        file_path = args[2]

count = defaultdict(int)

with open(file_path) as f:
    for line in f:
        match = re.search(r'\w+ \d{0,2} (?:\d{2}:?){3} (?:anatofuzMBP|anatofuz-15) ([\w.]+)\[\d+\]',line)
        if match:
            count[match.group(1)]+=1

total = 0

for key in count.keys():
    total +=count[key]

print(total)

```

### Perl6

```perl6
#!/usr/bin/env perl
use v6;

unit sub MAIN(:f($file) where { .IO.f } = '/var/log/system.log');

my $user_name = /'anatofuzMBP'|'anatofuz-15'/;
my $fh = open $file,:r;
my %count =();

for $fh.lines -> $line {
     if ( $line ~~ /\w+ \s \d**0..3 \s [\d**2\:?]**3 \s $user_name \s (<[\w.]>+)\[\d+\]/) {
         %count{$0}++;
    }
}
$fh.close;
my $sum = 0;

for %count.keys -> $key {
    $sum += %count{$key};
}

$sum.say;

```

ã¡ãªã¿ã«ãªã‚“ã§ã™ãŒPerl6ã®æ­£è¦è¡¨ç¾ã¯ãƒªãƒ†ãƒ©ãƒ«ä¸Šã®ç©ºç™½ã‚’ç„¡è¦–ã™ã‚‹ç‚ºï¼Œæ˜ç¤ºçš„ã«ç©ºç™½ãŒã‚ã‚‹ã¨æ›¸ã‹ãªã„ã¨ã„ã‘ã¾ã›ã‚“ï¼
ã¾ãŸç¯„å›²æ¼”ç®—å­ã¯ `**`ã‚’ã¤ã‘ã‚‹ãƒ«ãƒ¼ãƒ«ã¨ãªã£ã¦ã„ã¾ã™ï¼

### java

```java
package com.google.anatofuz;

import java.io.File;
import java.io.FileReader;
import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.*;
import java.util.regex.Pattern;
import java.util.regex.Matcher;

public class LogAnalyzer {

    public static void main(String args[]) {

        File file = new File("/var/log/system.log");

        if (args.length != 0) {
            if (args[0].equals("-f")) {
                file = new File(args[1]);
            }
        }

        try {
            FileReader filereader = new FileReader(file);
            BufferedReader bufferedReader = new BufferedReader(filereader);

            String line;
            Map<String,Integer>  map = new HashMap<String,Integer>(0);
            Pattern p = Pattern.compile("\\w+ \\d{0,2} (?:\\d{2}:?){3} (?:anatofuzMBP|anatofuz-15) ([\\w.]+)\\[\\d+\\]");


            while ((line = bufferedReader.readLine()) != null) {
                Matcher matcher = p.matcher(line);
                if (matcher.find()) {
                    map.merge(matcher.group(1),1,Integer::sum);
                }
            }

            int sum = 0;

            for (String key :map.keySet()){
                sum += map.get(key);
            }

            System.out.println(sum);


        } catch (FileNotFoundException ex){
            System.out.println(ex);
        } catch (IOException ex){
            System.out.println(ex);
        }
    }
}

```

ãªãŠjavaã¯buildãƒ„ãƒ¼ãƒ«ã®gradleã‚’åˆ©ç”¨ã—ã¦jarã«å›ºã‚ã¦ã„ã¾ã™


## è¨ˆæ¸¬

ç´ æœ´ã«zshã®timeã‚’ä½¿ã£ã¦è¨ˆæ¸¬ã—ã¾ã—ãŸï¼
ç°¡å˜ãªæ¬¡ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ï¼

```zsh
#!/bin/zsh
#

echo 'perl5'
time perl log_analyze.pl
echo '====='

echo 'ruby'
time ruby log_analyze.rb
echo '====='

echo 'python'
time python log_analyze.py
echo '====='

echo 'java'
time java -jar java/build/libs/anatofuz-1.0-SNAPSHOT.jar
echo '====='

echo 'perl6'
time perl6 log_analyze.p6
echo '====='

echo 'perl6 (debug)'
time /Users/anatofuz/workspace/cr/Basic/build_perl6/bin/perl6 log_analyze.p6
echo '====='

echo 'perl6(jvm)'
cd  /Users/anatofuz/workspace/cr/Basic/jvm/rakudo/
time /Users/anatofuz/workspace/cr/Basic/jvm/rakudo/perl6 /Users/anatofuz/workspace/cr/Basic/perl6/sandbox/log/log_analyze.p6

```


## å®Ÿè¡Œçµæœ

```
perl5
524
perl log_analyze.pl  0.04s user 0.03s system 84% cpu 0.090 total
=====
ruby
524
ruby log_analyze.rb  0.12s user 0.05s system 81% cpu 0.220 total
=====
python
524
python log_analyze.py  0.06s user 0.05s system 79% cpu 0.137 total
=====
java
524
java -jar java/build/libs/anatofuz-1.0-SNAPSHOT.jar  0.24s user 0.05s system 140% cpu 0.203 total
=====
perl6
524
perl6 log_analyze.p6  0.37s user 0.03s system 137% cpu 0.294 total
=====
perl6 (debug)
524
/Users/anatofuz/workspace/cr/Basic/build_perl6/bin/perl6 log_analyze.p6  0.78s user 0.07s system 112% cpu 0.752 total
=====
perl6(jvm)
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.perl6.nqp.runtime.Ops (file:/Users/anatofuz/workspace/cr/Basic/jvm/nqp/install/share/nqp/runtime/nqp-runtime.jar) to field sun.management.RuntimeImpl.jvm
WARNING: Please consider reporting this to the maintainers of org.perl6.nqp.runtime.Ops
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
524
/Users/anatofuz/workspace/cr/Basic/jvm/rakudo/perl6   21.26s user 0.67s system 439% cpu 4.983 total
```

ãƒˆãƒƒãƒ—ã¯Perl5ã§0.04ç§’ã§ã™ï¼ã‹ãªã‚Šæ—©ã„ã§ã™ã­ï¼
ç¶šã„ã¦å‡¦ç†ã¨ã—ã¦æ—©ã„ã®ã¯Pythonã§ã™ï¼æ­£è¦è¡¨ç¾ãªã©ãŒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã•ã‚Œã¦ã„ã¾ã—ãŸãŒé«˜é€Ÿã§ã™ã­ï¼
Rubyã¯eachæ–‡ã‚’ä½¿ã£ã¦ãªã„ãŸã‚ã‹0.12ã¨æ¯”è¼ƒçš„LLã®ä¸­ã§ã¯ä½é€Ÿã§ã™ï¼

Javaã¯Perl5ã®6å€,Rubyã®2å€ã§ã™ãŒï¼ŒJVMãŒè‹¦æ‰‹ãªæ­£è¦è¡¨ç¾ã‚’è¡Œã£ã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšãã“ãã“ã®é€Ÿåº¦ãŒå‡ºã¦ã„ã¾ã™ï¼
ã¾ãŸã“ã‚Œã§JVMè‡ªä½“ãŒé…ã„ã‚ã‘ã§ã¯ãªã„äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ï¼

ã•ã¦Perl6ã§ã™ãŒï¼ŒMoarVMã®å ´åˆ0.37ã¨Perl5ã®10å€é…ããªã£ã¦ã„ã¾ã™ï¼
debug optionã‚’ã¤ã‘ãŸå ´åˆã¯é€Ÿåº¦ãŒ0.78sã¨Perl5ã®19.5å€ã®é€Ÿåº¦ã¨ãªã£ã¦ã„ã¾ã™ï¼1.0så†…ã«åã¾ã£ã¦ã„ã¾ã™ãŒã‚„ã¯ã‚Šã¡ã‚‡ã£ã¨é…ã„ã§ã™ã­ï¼

ä¸€ç•ªã®å•é¡Œã¯JVMã«ä¹—ã£ãŸPerl6ã§ï¼Œä½•ã‹ã—ã‚‰å³ã—ã„ã‚¨ãƒ©ãƒ¼ãŒã²ã¨ã—ãã‚Šå‡ºã¦ã„ã‚‹ä¸Šã«21.26sæ›ã‹ã£ã¦ãŠã‚Šã¾ã™ï¼
å˜ç´”è¨ˆç®—ã§Perl5ã®531.5å€ã¨ãªã£ã¦ã„ã¾ã™ï¼Javaã¨æ¯”è¼ƒã—ã¦ã‚‚88å€ã¨JVMãŒæ‚ªã„ã‚ã‘ã§ã¯ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ï¼ä¸€ä½“ã©ã“ãŒåŸå› ãªã‚“ã ã‚ã†...

## æ„Ÿæƒ³

ã‚„ã¯ã‚Šãªã‚“ã¨ã„ã†ã‹Perl6å…¨ä½“çš„ã«é…ãï¼Œã“ã®Perl6ã‚’é«˜é€ŸåŒ–ã™ã‚‹ã¨ã„ã†ã®ã¯éå¸¸ã«ãƒ­ãƒãƒ³ãŒã‚ã‚‹ä¸–ç•Œã‹ã¨æ€ã‚ã‚Œã¾ã™ï¼
æ™‚é–“ã¯ã‹ã‹ã‚Šã¾ã™ãŒï¼Œä½¿ãˆãªã„ã“ã¨ã¯ãªã„ã®ã§çš†ã•ã‚“è©¦ã—ã¦ã¿ãŸã‚‰ã©ã†ã§ã—ã‚‡ã†ã‹ï¼
